---
layout: default
title: Journal
---

<h1 class="text-2xl font-bold mb-4">Journal</h1>

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet" />

<!-- Tabulator + Luxon JS -->
<script src="https://unpkg.com/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/default.css" />



<div id="journal-table" style="height: 500px;"></div>

<script>
  // ✅ Your Supabase details
  const supabaseUrl = "https://dibljhwqxxsvdwrzhchk.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpYmxqaHdxeHhzdmR3cnpoY2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMzgwOTAsImV4cCI6MjA2NDgxNDA5MH0.qcbOKHlDjua_ijVa_3mvnfjbZCl1wROJDtZ4naeZZko"
  const { createClient } = window.supabase;
  const supabase = createClient(supabaseUrl, supabaseKey);

  const USER_ID = "00000000-0000-0000-0000-000000000000";
  const ACTIVITY_TYPES = ["Buy", "Sell", "Dividend", "Split", "Interest", "Fee", "Other"];


  // ✅ Table setup
  const table = new Tabulator("#journal-table", {
    height: "500px",
    layout: "fitColumns",
    placeholder: "No entries yet — start typing to add.",
    reactiveData: true,
    history: true,
    data: [],

    columns : [
      { title: "ID", field: "id", visible: false, editable: false },
      
      {
        title: "Activity",
        field: "activity_type",
        editor: "list",               // use the new 'list' editor instead of 'select'
        editorParams: {
          values: ACTIVITY_TYPES,
          showListOnEmpty: true,     // this makes the dropdown open immediately on click
        },
        formatter: "plaintext",
      }

      ,
      { title: "Symbol", field: "symbol", editor: "input" },
      
        {
          title: "Trade Date",
          field: "trade_date",
          formatter: function(cell, formatterParams, onRendered){
            const val = cell.getValue();
            if(!val) return "";

            // Create container div for text + calendar icon
            const container = document.createElement("div");
            container.style.position = "relative";
            container.style.display = "flex";
            container.style.alignItems = "center";
            container.style.justifyContent = "space-between";
            container.style.paddingRight = "20px"; // space for icon

            // Date text span
            const textSpan = document.createElement("span");
            textSpan.textContent = val.slice(0,10); // format YYYY-MM-DD (assuming ISO string)
            textSpan.style.cursor = "text";

            // Calendar icon (simple SVG)
            const calIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            calIcon.setAttribute("viewBox", "0 0 24 24");
            calIcon.setAttribute("width", "16");
            calIcon.setAttribute("height", "16");
            calIcon.style.cursor = "pointer";
            calIcon.style.opacity = "0";
            calIcon.style.transition = "opacity 0.2s ease";
            calIcon.style.flexShrink = "0";
            calIcon.innerHTML = `
              <path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM5 8v10h14V8H5z"/>
            `;

            // Show icon on hover of container
            container.addEventListener("mouseenter", () => { calIcon.style.opacity = "1"; });
            container.addEventListener("mouseleave", () => { calIcon.style.opacity = "0"; });

            container.appendChild(textSpan);
            container.appendChild(calIcon);

            // When calendar icon clicked, open flatpickr popup
            calIcon.addEventListener("click", (e) => {
              e.stopPropagation();

              // Create a hidden input for flatpickr to bind
              const input = document.createElement("input");
              input.type = "text";
              input.style.position = "absolute";
              input.style.left = "-9999px"; // offscreen

              document.body.appendChild(input);

              const fp = flatpickr(input, {
                defaultDate: val.slice(0,10),
                onClose: () => {
                  fp.destroy();
                  document.body.removeChild(input);
                },
                onChange: (selectedDates, dateStr) => {
                  cell.setValue(dateStr);
                  fp.close();
                },
                dateFormat: "Y-m-d",
                allowInput: true,
                clickOpens: true,
              });

              fp.open();
            });

            return container;
          },
          editor: "input",
          editorParams: {
            type: "date"
          },
          mutator: function(value){
            // ensure value stored in ISO yyyy-mm-dd
            if(!value) return null;
            if(typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value)){
              return value;
            }
            try {
              const d = new Date(value);
              if(!isNaN(d)) {
                return d.toISOString().slice(0,10);
              }
            } catch {
              return null;
            }
            return null;
          }
        }

      ,
      {
        title: "quantity",
        field: "quantity",
        editor: "number",
        hozAlign: "right"
      },
      {
        title: "Price",
        field: "price",
        editor: "number",
        hozAlign: "right"
      },
      {
        title: "Fee",
        field: "fee",
        editor: "number",
        hozAlign: "right"
      },
      {
        title: "Note",
        field: "note",
        editor: "input"
      },
      {
        title: "Inserted At",
        field: "inserted_at",
        editable: false,
        formatter: "datetime",
        formatterParams: { outputFormat: "yyyy-LL-dd HH:mm:ss" }
      }
    ],


    cellEdited: async function (cell) {
      console.log("cellEdited triggered");
      const rowData = cell.getRow().getData();

      // Ensure ID exists
      if (!rowData.id) {
        rowData.id = crypto.randomUUID();
        cell.getRow().update({ id: rowData.id });
      }

      // Inject user ID if missing
      if (!rowData.user_id) {
        rowData.user_id = USER_ID;
        cell.getRow().update({ user_id: USER_ID });
      }

      // Optional: auto-fill inserted_at on first edit
      if (!rowData.inserted_at) {
        rowData.inserted_at = new Date().toISOString();
      }

      // Upsert to Supabase
      const { error } = await supabase
        .from("journal")
        .upsert([rowData], { onConflict: "id" });

      if (error) {
        console.error("Supabase upsert error:", error.message);
      } else {
        console.log("Row saved successfully:", rowData);
        loadData();  // Refresh data from Supabase
      }
    },

    rowAdded: function (row) {
      const data = row.getData();

      if (!data.id) {
        data.id = crypto.randomUUID();
      }

      if (!data.user_id) {
        data.user_id = USER_ID;
      }

      if (!data.inserted_at) {
        data.inserted_at = new Date().toISOString();
      }

      row.update(data);
    },

      // This triggers editor open on single click for the trade_date cell
    cellClick: function(e, cell) {
      if (cell.getField() === "trade_date") {
        cell.edit(true);  // open editor immediately on single click
      }
    },


  });

  // ✅ Load from Supabase
  async function loadData() {
    const { data, error } = await supabase
      .from("journal")
      .select("*")
      .eq("user_id", USER_ID)
      .order("trade_date", { ascending: false });

    if (error) {
      console.error("❌ Supabase fetch error:", error.message);
      return;
    }

    console.log("🧾 Data loaded from Supabase:");
    console.table(data);

    // Patch: Add ID if missing
    const patchedData = data.map(row => {
      if (!row.id) {
        row.id = crypto.randomUUID();
      }
      return row;
    });

    table.replaceData(patchedData);

    // Always ensure one empty row is present
    table.addRow({ user_id: USER_ID });
  }

  loadData();
</script>
