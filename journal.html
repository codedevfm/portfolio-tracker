---
layout: default
title: Journal
---

<h1 class="text-2xl font-bold mb-4">Journal</h1>

<!-- AG Grid CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- AG Grid JS -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/dist/ag-grid-community.min.js"></script>

<div id="journal-table" class="ag-theme-alpine" style="height: 500px; width: 100%; max-width: 800px; margin: 0 auto;"></div>

<script>
  function logWithTimestamp(...args) {
    const now = new Date().toISOString();
    console.log(`[${now}]`, ...args);
  }

  const supabaseUrl = "https://dibljhwqxxsvdwrzhchk.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpYmxqaHdxeHhzdmR3cnpoY2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMzgwOTAsImV4cCI6MjA2NDgxNDA5MH0.qcbOKHlDjua_ijVa_3mvnfjbZCl1wROJDtZ4naeZZko";
  const { createClient } = window.supabase;
  const supabase = createClient(supabaseUrl, supabaseKey);

  const USER_ID = "00000000-0000-0000-0000-000000000000";
  const ACTIVITY_TYPES = ["Buy", "Sell", "Dividend", "Split", "Interest", "Fee", "Other"];

  let gridApi;

  const gridOptions = {
    getRowId: params => params.data.id,
    columnDefs: [
      { field: "id", hide: true, editable: false },
      {
        field: "activity_type",
        editable: true,
        cellEditor: "agSelectCellEditor",
        cellEditorParams: { values: ACTIVITY_TYPES },
        valueFormatter: params => params.value || "",
      },
      { field: "symbol", editable: true },
      { field: "trade_date", editable: true },
      { field: "quantity", editable: true, valueParser: "number" },
      { field: "price", editable: true, valueParser: "number" },
      { field: "fee", editable: true, valueParser: "number" },
      { field: "note", editable: true },
      { field: "inserted_at", editable: false },
    ],
    defaultColDef: {
      filter: true,
      sortable: true,
      resizable: true,
    },
    pagination: false,
    animateRows: true,
    onGridReady: (params) => {
      gridApi = params.api;
      loadData("initial");
    },
    onCellValueChanged: async (params) => {
      const rowData = params.data;

      if (!rowData.id) {
        rowData.id = crypto.randomUUID();
        params.node.setDataValue("id", rowData.id);
      }

      if (!rowData.user_id) {
        rowData.user_id = USER_ID;
        params.node.setDataValue("user_id", USER_ID);
      }

      if (!rowData.inserted_at) {
        rowData.inserted_at = new Date().toISOString();
        params.node.setDataValue("inserted_at", rowData.inserted_at);
      }

      logWithTimestamp("‚¨ÜÔ∏è Update pushed to database:", rowData);

      const { error } = await supabase
        .from("journal")
        .upsert([rowData], { onConflict: "id" });

      if (error) {
        logWithTimestamp("‚ùå Supabase upsert error:", error.message);
      } else {
        logWithTimestamp("‚úÖ Row saved to Supabase successfully.");
      }
    },
    onRowDataUpdated: (params) => {
      const lastRow = gridApi.getDisplayedRowAtIndex(gridApi.getDisplayedRowCount() - 1);
      if (!lastRow || !lastRow.data || !lastRow.data.user_id) {
        gridApi.applyTransaction({ add: [{ user_id: USER_ID }] });
      }
    },
  };

  async function updateRowInGrid(updatedRow) {
    const nodeToUpdate = gridApi.getRowNode(updatedRow.id);
    if (nodeToUpdate) {
      nodeToUpdate.setData(updatedRow);
      logWithTimestamp("üîÑ Updated row in grid:", updatedRow);
    } else {
      gridApi.applyTransaction({ add: [updatedRow] });
      logWithTimestamp("‚ûï Added new row to grid:", updatedRow);
    }
  }

  async function loadData(source = "manual") {
    if (!gridApi) {
      logWithTimestamp("gridApi is not initialized. Ensure grid is ready.");
      return;
    }

    const { data, error } = await supabase
      .from("journal")
      .select("*")
      .eq("user_id", USER_ID)
      .order("trade_date", { ascending: false });

    if (error) {
      logWithTimestamp(`[${source}] ‚ùå Supabase fetch error:`, error.message);
      return;
    }

    logWithTimestamp(`[${source}] ‚¨áÔ∏è Update received from database.`);
    console.table(data);

    for (const row of data) {
      if (!row.id) continue;
      updateRowInGrid(row);
    }
  }

  async function fetchAndUpdateRowById(id, source = "manual") {
    const { data, error } = await supabase
      .from("journal")
      .select("*")
      .eq("id", id)
      .single();

    if (error || !data) {
      logWithTimestamp(`[${source}] ‚ùå Could not fetch updated row with id=${id}:`, error?.message || "Unknown error");
      return;
    }

    logWithTimestamp(`[${source}] ‚¨áÔ∏è Fetched updated row data from database, applying to grid.`);
    updateRowInGrid(data);
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (typeof agGrid === "undefined") {
      logWithTimestamp("AG Grid is not loaded. Check the script URL.");
      return;
    }

    new agGrid.Grid(document.querySelector("#journal-table"), gridOptions);

    supabase
      .channel("journal_changes")
      .on("postgres_changes", { event: "*", schema: "public", table: "journal" }, (payload) => {
        logWithTimestamp("üì° Realtime notification received from Supabase:", payload.eventType);

        const id = payload.new?.id || payload.old?.id;
        if (!id) {
          logWithTimestamp("‚ö†Ô∏è Received realtime update but no id was found in payload:", payload);
          return;
        }

        if (payload.eventType === "DELETE") {
          const nodeToRemove = gridApi.getRowNode(id);
          if (nodeToRemove) {
            gridApi.applyTransaction({ remove: [nodeToRemove.data] });
            logWithTimestamp(`[realtime] ‚¨áÔ∏è Row deleted from database, removed from grid:`, nodeToRemove.data);
          } else {
            logWithTimestamp(`[realtime] ‚¨áÔ∏è Row deleted but not found in grid: id=${id}`);
          }
        } else if (payload.new) {
          logWithTimestamp(`[realtime] ‚¨áÔ∏è Row updated in database, applying to grid.`);
          updateRowInGrid(payload.new);
        } else {
          fetchAndUpdateRowById(id, "realtime");
        }
      })
      .subscribe();
  });
</script>
