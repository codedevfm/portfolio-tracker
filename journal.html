---
layout: default
title: Journal
---

<h1 class="text-2xl font-bold mb-4">Journal</h1>

---

<link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<div id="journal-table" style="height: 500px;"></div>

<script>
  // ðŸ”§ Replace with your Supabase details
  const supabaseUrl = "https://dibljhwqxxsvdwrzhchk.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpYmxqaHdxeHhzdmR3cnpoY2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMzgwOTAsImV4cCI6MjA2NDgxNDA5MH0.qcbOKHlDjua_ijVa_3mvnfjbZCl1wROJDZ4naeZZko";
  const { createClient } = window.supabase;
  const supabase = createClient(supabaseUrl, supabaseKey);


  // For now, use a test/fixed user_id (replace with actual logic)
  const USER_ID = "00000000-0000-0000-0000-000000000000"; // Ensure this matches a user_id in your Supabase 'journal' table

  // Define columns - **Added 'id' column here**
  const columns = [
    { title: "ID", field: "id", visible: false, editable: false }, // Hidden but present
    { title: "Symbol", field: "symbol", editor: "input" },
    { title: "Buy Date", field: "buy_date", editor: "input",
      formatter: "datetime", formatterParams: { outputFormat: "YYYY-MM-DD" }, // Format date for display
      editorParams: {
        type: "date", // Use a date picker for better UX
        format: "YYYY-MM-DD"
      }
    },
    { title: "Buy Price", field: "buy_price", editor: "number", hozAlign: "right" },
    { title: "Quantity", field: "quantity", editor: "number", hozAlign: "right" },
    { title: "Inserted At", field: "inserted_at", editable: false,
      formatter: "datetime", formatterParams: { outputFormat: "YYYY-MM-DD HH:mm:ss" } // Format timestamp
    }
  ];

  // Initialize table
  const table = new Tabulator("#journal-table", {
    height: "500px",
    layout: "fitColumns",
    placeholder: "No trades yet â€” start typing to add.",
    reactiveData: true,
    history: true,
    data: [], // Start with empty data, loaded asynchronously
    columns: columns,
    cellEdited: async function (cell) {
      const rowData = cell.getRow().getData();

      // Add user_id if not already present
      if (!rowData.user_id) {
        rowData.user_id = USER_ID;
      }
      // Generate UUID if 'id' is missing (for newly added rows before first edit)
      if (!rowData.id) {
        rowData.id = crypto.randomUUID();
        cell.getRow().update({ id: rowData.id }); // Update the row in Tabulator with the new ID
      }

      // Upsert row into Supabase
      const { error } = await supabase
        .from("journal")
        .upsert([rowData], { onConflict: "id" });

      if (error) {
        console.error("Supabase upsert error:", error.message);
        // Optionally, revert the cell change or show a user-friendly error
      } else {
        console.log("Row saved successfully:", rowData);
        // After successful save, refresh the table to reflect any server-side changes (like inserted_at)
        loadData();
      }
    },
    rowAdded: function (row) {
      const data = row.getData();
      if (!data.id) {
        // Generate UUID for new rows immediately when they are added to the table
        data.id = crypto.randomUUID();
        row.update(data);
      }
      // You might also want to set inserted_at here for new rows if you're not relying solely on Supabase defaults
      if (!data.inserted_at) {
        data.inserted_at = new Date().toISOString();
        row.update(data);
      }
    },
  });

  // Load data from Supabase
  async function loadData() {
    const { data, error } = await supabase
      .from("journal")
      .select("*")
      .eq("user_id", USER_ID)
      .order("buy_date", { ascending: false });

    if (error) {
      console.error("Supabase fetch error:", error.message);
      return;
    }

    if (data) {
      table.replaceData(data);
      console.log("Data loaded successfully:", data);
    }
  }

  // Initial data load when the page loads
  loadData();
</script>