<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ page.title }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Ensure Supabase JS is loaded before it's used -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Moved from navbar.html's style block */
    .nav-link.active {
      color: #2563EB; /* Tailwind blue-600 */
      font-weight: 600;
      border-bottom: 2px solid #2563EB;
    }
    /* Styles for initial content hiding and loading spinner */
    .main-content-hidden {
      display: none;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #2563EB; /* Tailwind blue-600 */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="pt-16 bg-gray-100 text-gray-900">
  <!-- Loading Overlay - visible by default -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  {% include navbar.html %}
  <main id="main-content" class="w-full max-w-none p-6 main-content-hidden">
    {{ content }}
  </main>

  <script>
    const SUPABASE_URL = 'https://dibljhwqxxsvdwrzhchk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpYmxqaHdxeHhzdmR3cnpoY2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMzgwOTAsImV4cCI6MjA2NDgxNDA5MH0.qcbOKHlDjua_ijVa_3mvnfjbZCl1wROJDtZ4naeZZko';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const loadingOverlay = document.getElementById('loading-overlay');
    const mainContent = document.getElementById('main-content');
    const loginPath = "/portfolio-tracker/login.html";
    const currentPath = window.location.pathname;

    // Function to show content and hide loading overlay
    function showContent() {
      loadingOverlay.style.display = 'none';
      mainContent.classList.remove('main-content-hidden');
    }

    // Perform authentication check
    supabaseClient.auth.getSession()
      .then(({ data: { session } }) => {
        if (!session) {
          // If not authenticated and not on the login page, redirect immediately
          if (!currentPath.includes(loginPath)) {
            window.location.href = loginPath;
          } else {
            // If on login page and not authenticated, show content
            showContent();
          }
        } else {
          // If authenticated, show content
          showContent();
        }
      })
      .catch(error => {
        console.error("Error during session check:", error);
        // In case of an error, redirect to login or show content if on login page
        if (!currentPath.includes(loginPath)) {
          window.location.href = loginPath;
        } else {
          showContent();
        }
      });

    // Logout function
    async function handleLogout() {
      await supabaseClient.auth.signOut();
      window.location.href = loginPath;
    }

    // Attach logout event handler and navbar active class after DOM loads
    document.addEventListener('DOMContentLoaded', () => {
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        logoutButton.addEventListener('click', handleLogout);
      }

      // Mark current page active in navbar
      const current = window.location.pathname.split("/").pop();
      document.querySelectorAll(".nav-link").forEach(link => {
        const href = link.getAttribute("href").split("/").pop();
        if (href === current || (href === "index.html" && current === "")) {
          link.classList.add("active");
        }
      });
    });
  </script>
</body>
</html>
